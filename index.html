<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Inventarios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .auth-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 400px;
            margin: 100px auto;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-btn.active {
            background-color: var(--secondary);
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .results-container {
            margin-bottom: 30px;
        }
        
        .product-list {
            list-style: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: 500;
        }
        
        .product-price {
            color: #777;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .section {
            display: none;
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section.active {
            display: block;
        }
        
        .section-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        
        .admin-panel {
            display: none;
        }
        
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            background-color: var(--success);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }
        
        .notification.error {
            background-color: var(--danger);
        }
        
        .history-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .controls, .admin-nav {
                flex-direction: column;
            }
            
            .product-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .product-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Sistema de Gestión</div>
            <div id="userDisplay"></div>
        </div>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div id="loginContainer" class="auth-container">
            <div class="auth-form">
                <h2>Iniciar Sesión</h2>
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" placeholder="Ingresa tu usuario">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" placeholder="Ingresa tu contraseña">
                </div>
                <button class="btn btn-primary" onclick="login()">Ingresar</button>
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="dashboard">
            <div class="user-info">
                <h2 id="welcomeMessage">Bienvenido, Usuario</h2>
                <div>
                    <span id="deliveryTotal">Saldo de entrega: $0.00</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn active" data-section="delivery-section">Entrega</button>
                <button class="control-btn" data-section="low-section">Baja Defecto</button>
                <button class="control-btn" data-section="inventory-section">Inventario General</button>
                <button class="control-btn" data-section="history-section">Historial</button>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesión</button>
            </div>

            <!-- Delivery Section -->
            <div id="delivery-section" class="section active">
                <h3 class="section-title">Productos para Entrega</h3>
                <table id="delivery-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="delivery-items">
                        <!-- Delivery items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3">Total a Pagar</td>
                            <td id="delivery-total">$0.00</td>
                            <td>
                                <button class="btn btn-success" onclick="generateDelivery()">Generar Entrega</button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Low Products Section -->
            <div id="low-section" class="section">
                <h3 class="section-title">Productos para Baja</h3>
                <table id="low-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="low-items">
                        <!-- Low items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">
                                <button class="btn btn-danger" onclick="generateLow()">Realizar Bajas</button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Inventory Section -->
            <div id="inventory-section" class="section">
                <h3 class="section-title">Inventario General</h3>
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-items">
                        <!-- Inventory items will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- History Section -->
            <div id="history-section" class="section">
                <h3 class="section-title">Historial</h3>
                <div id="history-tabs">
                    <button class="control-btn active" data-history="delivery-history">Entregas</button>
                    <button class="control-btn" data-history="low-history">Bajas</button>
                </div>
                
                <div id="delivery-history" class="history-content">
                    <h4>Historial de Entregas</h4>
                    <div id="delivery-history-list">
                        <!-- Delivery history will be added here -->
                    </div>
                </div>
                
                <div id="low-history" class="history-content" style="display: none;">
                    <h4>Historial de Bajas</h4>
                    <div id="low-history-list">
                        <!-- Low history will be added here -->
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Buscar producto por nombre o precio..." oninput="searchProducts()">
            </div>

            <div class="results-container">
                <ul id="search-results" class="product-list">
                    <!-- Search results will appear here -->
                </ul>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <h2>Panel de Administrador</h2>
            
            <div class="admin-nav">
                <button class="control-btn active" data-admin="deliveries-admin">Historial de Entregas</button>
                <button class="control-btn" data-admin="lows-admin">Historial de Bajas</button>
                <button class="control-btn" data-admin="inventory-admin">Gestión de Inventarios</button>
                <button class="control-btn" data-admin="notifications-admin">Notificaciones</button>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesión</button>
            </div>

            <!-- Admin Deliveries Section -->
            <div id="deliveries-admin" class="section active">
                <h3 class="section-title">Historial de Entregas</h3>
                <div id="admin-deliveries-list">
                    <!-- Admin deliveries will be added here -->
                </div>
            </div>

            <!-- Admin Lows Section -->
            <div id="lows-admin" class="section">
                <h3 class="section-title">Historial de Bajas</h3>
                <div id="admin-lows-list">
                    <!-- Admin lows will be added here -->
                </div>
            </div>

            <!-- Admin Inventory Section -->
            <div id="inventory-admin" class="section">
                <h3 class="section-title">Gestión de Inventarios</h3>
                <div class="form-group">
                    <label for="user-select">Seleccionar Vendedor:</label>
                    <select id="user-select" onchange="loadUserInventory()">
                        <option value="usuario1">Isaac</option>
                        <option value="usuario2">Vendedor 2</option>
                        <option value="usuario3">Vendedor 3</option>
                        <option value="usuario4">Vendedor 4</option>
                        <option value="usuario5">Vendedor 5</option>
                    </select>
                </div>
                
                <div id="admin-inventory-container">
                    <table id="admin-inventory-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-inventory-items">
                            <!-- Admin inventory items will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>Agregar Nuevo Producto</h4>
                    <div class="form-group">
                        <input type="text" id="new-product-name" placeholder="Nombre del producto">
                    </div>
                    <div class="form-group">
                        <input type="number" id="new-product-price" placeholder="Precio" step="0.01">
                    </div>
                    <div class="form-group">
                        <input type="number" id="new-product-quantity" placeholder="Cantidad">
                    </div>
                    <button class="btn btn-success" onclick="addNewProduct()">Agregar Producto</button>
                </div>
            </div>

            <!-- Admin Notifications Section -->
            <div id="notifications-admin" class="section">
                <h3 class="section-title">Notificaciones</h3>
                <div id="notifications-list">
                    <!-- Notifications will be added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar acción</h3>
            <p id="modalMessage">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmAction()">Confirmar</button>
                <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let users = {
            "usuario1": { password: "queriquera1", name: "Isaac", inventory: [] },
            "usuario2": { password: "pass2", name: "Vendedor 2", inventory: [] },
            "usuario3": { password: "pass3", name: "Vendedor 3", inventory: [] },
            "usuario4": { password: "pass4", name: "Vendedor 4", inventory: [] },
            "usuario5": { password: "pass5", name: "Vendedor 5", inventory: [] },
            "admin": { password: "Ludmila76", name: "Administrador", inventory: [] }
        };

        let deliveryItems = [];
        let lowItems = [];
        let deliveryHistory = [];
        let lowHistory = [];
        let notifications = [];

        // Initialize with sample data
        function initializeData() {
            // Sample products for each user
            const sampleProducts = [
                { id: 1, name: "Producto A", price: 10.50, quantity: 20 },
                { id: 2, name: "Producto B", price: 15.75, quantity: 15 },
                { id: 3, name: "Producto C", price: 8.30, quantity: 30 },
                { id: 4, name: "Producto D", price: 25.00, quantity: 10 },
                { id: 5, name: "Producto E", price: 5.50, quantity: 50 }
            ];

            // Assign different inventories to each user
            for (let i = 1; i <= 5; i++) {
                const userKey = `usuario${i}`;
                users[userKey].inventory = JSON.parse(JSON.stringify(sampleProducts));
                
                // Modify prices and quantities for variety
                users[userKey].inventory.forEach((product, index) => {
                    product.price = (product.price * (0.9 + (i * 0.05))).toFixed(2);
                    product.quantity = product.quantity - (i * 2) + (index * 3);
                    if (product.quantity < 0) product.quantity = 5;
                });
            }

            // Load data from localStorage if available
            loadFromLocalStorage();
            
            // Set up event listeners
            setupEventListeners();
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const usersData = localStorage.getItem('usersData');
                if (usersData) {
                    const parsedData = JSON.parse(usersData);
                    for (const key in parsedData) {
                        if (users[key]) {
                            users[key].inventory = parsedData[key].inventory || users[key].inventory;
                        }
                    }
                }

                const deliveryHistoryData = localStorage.getItem('deliveryHistory');
                if (deliveryHistoryData) {
                    deliveryHistory = JSON.parse(deliveryHistoryData);
                }

                const lowHistoryData = localStorage.getItem('lowHistory');
                if (lowHistoryData) {
                    lowHistory = JSON.parse(lowHistoryData);
                }

                const notificationsData = localStorage.getItem('notifications');
                if (notificationsData) {
                    notifications = JSON.parse(notificationsData);
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
            }
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                // Save users data
                const usersData = {};
                for (const key in users) {
                    usersData[key] = {
                        inventory: users[key].inventory
                    };
                }
                localStorage.setItem('usersData', JSON.stringify(usersData));
                
                // Save history
                localStorage.setItem('deliveryHistory', JSON.stringify(deliveryHistory));
                localStorage.setItem('lowHistory', JSON.stringify(lowHistory));
                
                // Save notifications
                localStorage.setItem('notifications', JSON.stringify(notifications));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Section control buttons
            document.querySelectorAll('.control-btn[data-section]').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    
                    // Deactivate all buttons and sections
                    document.querySelectorAll('.control-btn[data-section]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Activate current button and section
                    this.classList.add('active');
                    document.getElementById(sectionId).classList.add('active');
                });
            });

            // History tabs
            document.querySelectorAll('.control-btn[data-history]').forEach(button => {
                button.addEventListener('click', function() {
                    const historyId = this.getAttribute('data-history');
                    
                    // Deactivate all buttons and history content
                    document.querySelectorAll('.control-btn[data-history]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.history-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Activate current button and history content
                    this.classList.add('active');
                    document.getElementById(historyId).style.display = 'block';
                });
            });

            // Admin tabs
            document.querySelectorAll('.control-btn[data-admin]').forEach(button => {
                button.addEventListener('click', function() {
                    const adminSectionId = this.getAttribute('data-admin');
                    
                    // Deactivate all buttons and sections
                    document.querySelectorAll('.control-btn[data-admin]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Activate current button and section
                    this.classList.add('active');
                    document.getElementById(adminSectionId).classList.add('active');
                });
            });
        }

        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Por favor ingresa usuario y contraseña', true);
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                
                // Hide login, show appropriate dashboard
                document.getElementById('loginContainer').style.display = 'none';
                
                if (username === 'admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    loadAdminData();
                } else {
                    document.getElementById('userDashboard').style.display = 'block';
                    document.getElementById('welcomeMessage').textContent = `Bienvenido, ${users[username].name}`;
                    loadUserData();
                }
                
                showNotification(`Bienvenido ${users[username].name}`);
            } else {
                showNotification('Usuario o contraseña incorrectos', true);
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            deliveryItems = [];
            lowItems = [];
            
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('userDashboard').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Load user data
        function loadUserData() {
            updateDeliveryDisplay();
            loadInventory();
            loadHistory();
        }

        // Load admin data
        function loadAdminData() {
            loadAdminDeliveries();
            loadAdminLows();
            loadUserInventory();
            loadNotifications();
        }

        // Search products
        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (!searchTerm) return;
            
            const userInventory = users[currentUser].inventory;
            const filteredProducts = userInventory.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.price.toString().includes(searchTerm)
            );
            
            filteredProducts.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">Precio: $${product.price} | Stock: ${product.quantity}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-success" onclick="addToDelivery(${product.id})">Agregar</button>
                        <button class="btn btn-danger" onclick="addToLow(${product.id})">Baja</button>
                    </div>
                `;
                resultsContainer.appendChild(li);
            });
        }

        // Add product to delivery
        function addToDelivery(productId) {
            const product = users[currentUser].inventory.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product already in delivery
            const existingItem = deliveryItems.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.quantity) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                existingItem.quantity++;
            } else {
                if (product.quantity < 1) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                deliveryItems.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    quantity: 1
                });
            }
            
            updateDeliveryDisplay();
            showNotification('Producto agregado a entrega');
        }

        // Add product to low items
        function addToLow(productId) {
            const product = users[currentUser].inventory.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product already in low items
            const existingItem = lowItems.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.quantity) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                existingItem.quantity++;
            } else {
                if (product.quantity < 1) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                lowItems.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    quantity: 1
                });
            }
            
            updateLowDisplay();
            showNotification('Producto agregado a bajas');
        }

        // Update delivery display
        function updateDeliveryDisplay() {
            const deliveryItemsContainer = document.getElementById('delivery-items');
            const deliveryTotalElement = document.getElementById('delivery-total');
            const deliveryTotalDisplay = document.getElementById('deliveryTotal');
            
            deliveryItemsContainer.innerHTML = '';
            let total = 0;
            
            deliveryItems.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <button onclick="changeDeliveryQuantity(${item.id}, -1)">-</button>
                        ${item.quantity}
                        <button onclick="changeDeliveryQuantity(${item.id}, 1)">+</button>
                    </td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>$${subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeFromDelivery(${item.id})">Eliminar</button>
                    </td>
                `;
                deliveryItemsContainer.appendChild(tr);
            });
            
            deliveryTotalElement.textContent = `$${total.toFixed(2)}`;
            deliveryTotalDisplay.textContent = `Saldo de entrega: $${total.toFixed(2)}`;
        }

        // Update low items display
        function updateLowDisplay() {
            const lowItemsContainer = document.getElementById('low-items');
            lowItemsContainer.innerHTML = '';
            
            lowItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <button onclick="changeLowQuantity(${item.id}, -1)">-</button>
                        ${item.quantity}
                        <button onclick="changeLowQuantity(${item.id}, 1)">+</button>
                    </td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeFromLow(${item.id})">Eliminar</button>
                    </td>
                `;
                lowItemsContainer.appendChild(tr);
            });
        }

        // Change delivery quantity
        function changeDeliveryQuantity(productId, change) {
            const item = deliveryItems.find(item => item.id === productId);
            if (!item) return;
            
            const product = users[currentUser].inventory.find(p => p.id === productId);
            
            if (change > 0) {
                if (item.quantity >= product.quantity) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                item.quantity++;
            } else {
                if (item.quantity <= 1) {
                    removeFromDelivery(productId);
                    return;
                }
                item.quantity--;
            }
            
            updateDeliveryDisplay();
        }

        // Change low quantity
        function changeLowQuantity(productId, change) {
            const item = lowItems.find(item => item.id === productId);
            if (!item) return;
            
            const product = users[currentUser].inventory.find(p => p.id === productId);
            
            if (change > 0) {
                if (item.quantity >= product.quantity) {
                    showNotification('No hay suficiente stock', true);
                    return;
                }
                item.quantity++;
            } else {
                if (item.quantity <= 1) {
                    removeFromLow(productId);
                    return;
                }
                item.quantity--;
            }
            
            updateLowDisplay();
        }

        // Remove from delivery
        function removeFromDelivery(productId) {
            deliveryItems = deliveryItems.filter(item => item.id !== productId);
            updateDeliveryDisplay();
            showNotification('Producto eliminado de entrega');
        }

        // Remove from low items
        function removeFromLow(productId) {
            lowItems = lowItems.filter(item => item.id !== productId);
            updateLowDisplay();
            showNotification('Producto eliminado de bajas');
        }

        // Load inventory
        function loadInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';
            
            const userInventory = users[currentUser].inventory;
            userInventory.sort((a, b) => a.name.localeCompare(b.name));
            
            userInventory.forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <button class="btn btn-success" onclick="addToDelivery(${product.id})">Agregar</button>
                        <button class="btn btn-danger" onclick="addToLow(${product.id})">Baja</button>
                    </td>
                `;
                inventoryContainer.appendChild(tr);
            });
        }

        // Load history
        function loadHistory() {
            const deliveryHistoryList = document.getElementById('delivery-history-list');
            const lowHistoryList = document.getElementById('low-history-list');
            
            deliveryHistoryList.innerHTML = '';
            lowHistoryList.innerHTML = '';
            
            // Filter history for current user
            const userDeliveryHistory = deliveryHistory.filter(record => record.user === currentUser);
            const userLowHistory = lowHistory.filter(record => record.user === currentUser);
            
            userDeliveryHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>Fecha:</strong> ${new Date(record.date).toLocaleString()} <br>
                        <strong>Total:</strong> $${record.total.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="downloadPDF('delivery', ${record.id})">Descargar PDF</button>
                    </div>
                `;
                deliveryHistoryList.appendChild(historyItem);
            });
            
            userLowHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>Fecha:</strong> ${new Date(record.date).toLocaleString()} <br>
                        <strong>Productos:</strong> ${record.items.length}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="downloadPDF('low', ${record.id})">Descargar PDF</button>
                    </div>
                `;
                lowHistoryList.appendChild(historyItem);
            });
        }

        // Generate delivery
        function generateDelivery() {
            if (deliveryItems.length === 0) {
                showNotification('No hay productos en la entrega', true);
                return;
            }
            
            showConfirmationModal(
                'Confirmar Entrega',
                '¿Estás seguro de que deseas generar la entrega? Esta acción no se puede deshacer.',
                () => {
                    // Calculate total
                    const total = deliveryItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    
                    // Create delivery record
                    const deliveryRecord = {
                        id: Date.now(),
                        date: new Date(),
                        user: currentUser,
                        items: [...deliveryItems],
                        total: total
                    };
                    
                    // Update inventory
                    deliveryItems.forEach(deliveryItem => {
                        const product = users[currentUser].inventory.find(p => p.id === deliveryItem.id);
                        if (product) {
                            product.quantity -= deliveryItem.quantity;
                            
                            // Check if product is out of stock and add notification
                            if (product.quantity === 0) {
                                addNotification(`Producto agotado: ${product.name} para ${users[currentUser].name}`);
                            }
                        }
                    });
                    
                    // Add to history
                    deliveryHistory.push(deliveryRecord);
                    
                    // Generate PDF
                    generateDeliveryPDF(deliveryRecord);
                    
                    // Reset delivery items
                    deliveryItems = [];
                    updateDeliveryDisplay();
                    
                    // Save data
                    saveToLocalStorage();
                    
                    showNotification('Entrega generada exitosamente');
                }
            );
        }

        // Generate low items
        function generateLow() {
            if (lowItems.length === 0) {
                showNotification('No hay productos para dar de baja', true);
                return;
            }
            
            showConfirmationModal(
                'Confirmar Bajas',
                '¿Estás seguro de que deseas realizar las bajas? Esta acción no se puede deshacer.',
                () => {
                    // Create low record
                    const lowRecord = {
                        id: Date.now(),
                        date: new Date(),
                        user: currentUser,
                        items: [...lowItems],
                        total: lowItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                    };
                    
                    // Update inventory
                    lowItems.forEach(lowItem => {
                        const product = users[currentUser].inventory.find(p => p.id === lowItem.id);
                        if (product) {
                            product.quantity -= lowItem.quantity;
                            
                            // Check if product is out of stock and add notification
                            if (product.quantity === 0) {
                                addNotification(`Producto agotado: ${product.name} para ${users[currentUser].name}`);
                            }
                        }
                    });
                    
                    // Add to history
                    lowHistory.push(lowRecord);
                    
                    // Generate PDF
                    generateLowPDF(lowRecord);
                    
                    // Reset low items
                    lowItems = [];
                    updateLowDisplay();
                    
                    // Save data
                    saveToLocalStorage();
                    
                    showNotification('Bajas realizadas exitosamente');
                }
            );
        }

        // Generate delivery PDF
        function generateDeliveryPDF(deliveryRecord) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Comprobante de Entrega', 105, 15, { align: 'center' });
            
            // Details
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date(deliveryRecord.date).toLocaleString()}`, 14, 25);
            doc.text(`Vendedor: ${users[deliveryRecord.user].name}`, 14, 32);
            
            // Table
            const tableData = deliveryRecord.items.map(item => [
                item.name,
                item.quantity,
                `$${item.price.toFixed(2)}`,
                `$${(item.price * item.quantity).toFixed(2)}`
            ]);
            
            tableData.push([
                'TOTAL',
                '',
                '',
                `$${deliveryRecord.total.toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: 40,
                head: [['Producto', 'Cantidad', 'Precio', 'Subtotal']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] }
            });
            
            // Save PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Store PDF URL in history record
            deliveryRecord.pdfUrl = pdfUrl;
            
            // For immediate download
            doc.save(`entrega_${deliveryRecord.id}.pdf`);
        }

        // Generate low PDF
        function generateLowPDF(lowRecord) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Comprobante de Baja', 105, 15, { align: 'center' });
            
            // Details
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date(lowRecord.date).toLocaleString()}`, 14, 25);
            doc.text(`Vendedor: ${users[lowRecord.user].name}`, 14, 32);
            
            // Table
            const tableData = lowRecord.items.map(item => [
                item.name,
                item.quantity,
                `$${item.price.toFixed(2)}`,
                `$${(item.price * item.quantity).toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: 40,
                head: [['Producto', 'Cantidad', 'Precio', 'Subtotal']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] }
            });
            
            // Save PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Store PDF URL in history record
            lowRecord.pdfUrl = pdfUrl;
            
            // For immediate download
            doc.save(`baja_${lowRecord.id}.pdf`);
        }

        // Download PDF
        function downloadPDF(type, recordId) {
            let record;
            
            if (type === 'delivery') {
                record = deliveryHistory.find(r => r.id === recordId);
            } else {
                record = lowHistory.find(r => r.id === recordId);
            }
            
            if (record && record.pdfUrl) {
                const a = document.createElement('a');
                a.href = record.pdfUrl;
                a.download = `${type}_${recordId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                showNotification('PDF no disponible', true);
            }
        }

        // Load admin deliveries
        function loadAdminDeliveries() {
            const adminDeliveriesList = document.getElementById('admin-deliveries-list');
            adminDeliveriesList.innerHTML = '';
            
            deliveryHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>Vendedor:</strong> ${users[record.user].name} <br>
                        <strong>Fecha:</strong> ${new Date(record.date).toLocaleString()} <br>
                        <strong>Total:</strong> $${record.total.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="downloadPDF('delivery', ${record.id})">Descargar PDF</button>
                    </div>
                `;
                adminDeliveriesList.appendChild(historyItem);
            });
        }

        // Load admin lows
        function loadAdminLows() {
            const adminLowsList = document.getElementById('admin-lows-list');
            adminLowsList.innerHTML = '';
            
            lowHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>Vendedor:</strong> ${users[record.user].name} <br>
                        <strong>Fecha:</strong> ${new Date(record.date).toLocaleString()} <br>
                        <strong>Productos:</strong> ${record.items.length}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="downloadPDF('low', ${record.id})">Descargar PDF</button>
                        <button class="btn btn-success" onclick="approveLow(${record.id})">Aprobar</button>
                    </div>
                `;
                adminLowsList.appendChild(historyItem);
            });
        }

        // Approve low
        function approveLow(recordId) {
            const record = lowHistory.find(r => r.id === recordId);
            if (!record) return;
            
            // Mark as approved
            record.approved = true;
            
            // Save data
            saveToLocalStorage();
            
            showNotification('Baja aprobada exitosamente');
        }

        // Load user inventory for admin
        function loadUserInventory() {
            const userSelect = document.getElementById('user-select');
            const selectedUser = userSelect.value;
            const inventoryContainer = document.getElementById('admin-inventory-items');
            inventoryContainer.innerHTML = '';
            
            const userInventory = users[selectedUser].inventory;
            userInventory.sort((a, b) => a.name.localeCompare(b.name));
            
            userInventory.forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteProduct('${selectedUser}', ${product.id})">Eliminar</button>
                    </td>
                `;
                inventoryContainer.appendChild(tr);
            });
        }

        // Add new product
        function addNewProduct() {
            const userSelect = document.getElementById('user-select');
            const selectedUser = userSelect.value;
            const nameInput = document.getElementById('new-product-name');
            const priceInput = document.getElementById('new-product-price');
            const quantityInput = document.getElementById('new-product-quantity');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const quantity = parseInt(quantityInput.value);
            
            if (!name || isNaN(price) || isNaN(quantity) || price <= 0 || quantity < 0) {
                showNotification('Por favor ingresa valores válidos', true);
                return;
            }
            
            // Generate unique ID
            const newId = Math.max(0, ...users[selectedUser].inventory.map(p => p.id)) + 1;
            
            // Add product
            users[selectedUser].inventory.push({
                id: newId,
                name: name,
                price: price,
                quantity: quantity
            });
            
            // Clear inputs
            nameInput.value = '';
            priceInput.value = '';
            quantityInput.value = '';
            
            // Reload inventory
            loadUserInventory();
            
            // Save data
            saveToLocalStorage();
            
            showNotification('Producto agregado exitosamente');
        }

        // Delete product
        function deleteProduct(user, productId) {
            showConfirmationModal(
                'Eliminar Producto',
                '¿Estás seguro de que deseas eliminar este producto?',
                () => {
                    users[user].inventory = users[user].inventory.filter(p => p.id !== productId);
                    loadUserInventory();
                    saveToLocalStorage();
                    showNotification('Producto eliminado exitosamente');
                }
            );
        }

        // Load notifications
        function loadNotifications() {
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p>No hay notificaciones</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'history-item';
                notificationItem.innerHTML = `
                    <div>
                        <strong>${new Date(notification.date).toLocaleString()}</strong> <br>
                        ${notification.message}
                    </div>
                `;
                notificationsList.appendChild(notificationItem);
            });
        }

        // Add notification
        function addNotification(message) {
            notifications.push({
                id: Date.now(),
                date: new Date(),
                message: message
            });
            
            saveToLocalStorage();
        }

        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Show confirmation modal
        function showConfirmationModal(title, message, confirmCallback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmationModal').style.display = 'flex';
            
            window.confirmAction = confirmCallback;
        }

        // Close modal
        function closeModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        // Confirm action
        function confirmAction() {
            if (typeof window.confirmAction === 'function') {
                window.confirmAction();
            }
            closeModal();
        }

        // Initialize the application
        window.onload = function() {
            initializeData();
            
            // Check if user is already logged in (for demo purposes)
            // In a real application, you would check from session storage or cookies
        };
    </script>
</body>
</html>
