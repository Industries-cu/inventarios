<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Web</title>
    <style>
        /* Estilos CSS mejorados */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 50px;
        }

        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }

        .auth-container, .panel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .auth-form button {
            background-color: #007BFF;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .auth-form button:hover {
            background-color: #0056b3;
        }

        .panel-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-header h2 {
            margin: 0;
            color: #555;
        }

        .logout-btn {
            background-color: #dc3545;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .panel-vendedor, .panel-admin {
            width: 100%;
        }

        .panel-vendedor .buttons-section, .panel-admin .buttons-section {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }

        .panel-vendedor .buttons-section button, .panel-admin .buttons-section button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #btn-registro-entrega {
            background-color: #28a745;
        }
        #btn-registro-baja {
            background-color: #dc3545;
        }
        #btn-inventario-total {
            background-color: #007BFF;
        }

        #btn-registro-entrega:hover {
            background-color: #218838;
        }
        #btn-registro-baja:hover {
            background-color: #c82333;
        }
        #btn-inventario-total:hover {
            background-color: #0056b3;
        }

        #search-bar {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #inventario-results {
            width: 100%;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .producto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .producto:last-child {
            border-bottom: none;
        }

        .producto-info {
            flex-grow: 1;
        }

        .producto-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-agregar {
            background-color: #17a2b8; /* Azul claro */
        }
        .btn-dar-baja {
            background-color: #fd7e14; /* Rojo claro */
        }

        .registros-container {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .registros-container h3 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .registro-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dotted #ccc;
        }
        
        .registro-item:last-child {
            border-bottom: none;
        }

        .total-registro {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #333;
            text-align: right;
        }

        .complete-btn {
            background-color: #28a745;
            color: #fff;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-size: 16px;
        }

        .btn-quitar {
            background-color: #dc3545;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .panel-admin .buttons-section button {
            background-color: #6c757d;
        }

        .panel-admin .buttons-section button:hover {
            background-color: #5a6268;
        }

        #file-input {
            display: none;
        }

        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 12px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border-radius: 8px;
            margin-top: 20px;
        }

        .pdf-preview {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }

        .pdf-preview h4 {
            margin-top: 0;
        }

        .confirm-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="auth-container" id="auth-container">
            <h1>Bienvenido a Inventario Web</h1>
            <form class="auth-form" id="login-form">
                <input type="text" id="username" placeholder="Usuario" list="users-list" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit">Iniciar Sesión</button>
            </form>
            <datalist id="users-list">
                <option value="Isaac">
                <option value="Lien">
                <option value="Alain">
                <option value="Adiane">
                <option value="Yuniaky">
                <option value="Riselda">
                <option value="Taller">
                <option value="Nailin">
                <option value="Marcia">
                <option value="Admin">
            </datalist>
        </div>

        <div class="panel-container hidden" id="vendedor-panel">
            <div class="panel-header">
                <h2 id="welcome-message"></h2>
                <button class="logout-btn" id="logout-btn">Cerrar Sesión</button>
            </div>
            
            <div class="panel-vendedor">
                <div class="buttons-section">
                    <button id="btn-registro-entrega">Registro de Entrega</button>
                    <button id="btn-registro-baja">Registro de Baja</button>
                    <button id="btn-inventario-total">Inventario Total</button>
                </div>

                <div id="vendedor-content">
                    </div>
            </div>
        </div>

        <div class="panel-container hidden" id="admin-panel">
            <div class="panel-header">
                <h2 id="admin-welcome-message"></h2>
                <button class="logout-btn" id="logout-btn-admin">Cerrar Sesión</button>
            </div>

            <div class="panel-admin">
                <div class="buttons-section">
                    <button id="btn-editar-inventario">Editar Inventario</button>
                    <button id="btn-cargar-entrega">Cargar Registro de Entrega</button>
                    <button id="btn-cargar-baja">Cargar Registro de Baja</button>
                </div>
                <div id="admin-content">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <script>
        // Script de JavaScript
        let db; // La variable `db` se inicializará después de cargar el JSON
        let currentInventario = [];
        let registroEntrega = [];
        let registroBaja = [];
        let currentUser; // Variable para almacenar el usuario actual
        let currentDbFile;

        const users = {
            'Isaac': 'Isaac',
            'Lien': 'Lien',
            'Alain': 'Alain',
            'Adiane': 'Adiane',
            'Yuniaky': 'Yuniaky',
            'Riselda': 'Riselda',
            'Taller': 'Taller',
            'Nailin': 'Nailin',
            'Marcia': 'Marcia',
            'Admin': 'Ludmila76'
        };

        const userFiles = {
            'Isaac': 'db.json',
            'Lien': 'dblien.json',
            'Alain': 'dbAlain.json',
            'Adiane': 'dbAdiane.json',
            'Yuniaky': 'dbyuniaky.json',
            'Riselda': 'dbRiselda.json',
            'Taller': 'dbtaller.json',
            'Nailin': 'dbNailin.json',
            'Marcia': 'dbMarcia.json',
        };

        const SESSION_DURATION = 5 * 60 * 60 * 1000; // 5 horas en milisegundos

        // Función para cargar el archivo JSON y evitar el caché
        async function loadInventory(fileName) {
            try {
                // Agrega una marca de tiempo a la URL para evitar el caché del navegador
                const cacheBuster = new Date().getTime();
                const response = await fetch(`${fileName}?v=${cacheBuster}`);
                if (!response.ok) {
                    throw new Error(`No se pudo cargar el archivo ${fileName}`);
                }
                const data = await response.json();
                db = data;
                currentInventario = [...db.inventario];
                currentDbFile = fileName; // Guardar el nombre del archivo para la sesión
                registroEntrega = JSON.parse(localStorage.getItem('registroEntrega')) || [];
                registroBaja = JSON.parse(localStorage.getItem('registroBaja')) || [];
            } catch (error) {
                console.error(error);
                alert(`No se pudo cargar el inventario. Asegúrate de que el archivo ${fileName} esté en la misma carpeta.`);
                db = { "inventario": [], "registros_entrega": [], "registros_baja": [] };
            }
        }

        // Función para verificar y restaurar la sesión
        function checkSession() {
            const storedSession = localStorage.getItem('session');
            if (storedSession) {
                const session = JSON.parse(storedSession);
                const currentTime = new Date().getTime();
                if (currentTime - session.timestamp < SESSION_DURATION) {
                    currentUser = session.username;
                    const fileName = userFiles[currentUser];
                    loadInventory(fileName).then(() => {
                        showPanel(currentUser);
                    });
                } else {
                    alert('Tu sesión ha expirado. Por favor, vuelve a iniciar sesión.');
                    logout();
                }
            }
        }

        // Función para mostrar el panel correcto
        function showPanel(username) {
            document.getElementById('auth-container').classList.add('hidden');
            if (username === 'Admin') {
                document.getElementById('admin-welcome-message').textContent = `Hola, ${username}!`;
                document.getElementById('admin-panel').classList.remove('hidden');
                renderAdminPanel();
            } else {
                document.getElementById('welcome-message').textContent = `Hola, ${username}!`;
                document.getElementById('vendedor-panel').classList.remove('hidden');
                renderInventario();
            }
        }
        
        // Funciones del Vendedor
        function renderInventario() {
            const content = document.getElementById('vendedor-content');
            content.innerHTML = `
                <input type="text" id="search-bar" placeholder="Buscar por nombre o precio...">
                <div id="inventario-results"></div>
            `;
            const searchBar = document.getElementById('search-bar');
            searchBar.addEventListener('input', (e) => searchInventario(e.target.value));
            searchInventario('');
        }

        function searchInventario(query) {
            const resultsDiv = document.getElementById('inventario-results');
            resultsDiv.innerHTML = '';
            const normalizedQuery = query.toLowerCase();

            const filtered = currentInventario.filter(item =>
                item.nombre.toLowerCase().includes(normalizedQuery) ||
                item.precio.toString().includes(normalizedQuery)
            );

            if (filtered.length > 0) {
                filtered.forEach(item => {
                    const productoDiv = document.createElement('div');
                    productoDiv.className = 'producto';
                    productoDiv.innerHTML = `
                        <div class="producto-info">
                            <strong>${item.nombre}</strong> - Cantidad: ${item.cantidad}, Precio: $${item.precio.toFixed(2)}
                        </div>
                        <div class="producto-actions">
                            <button class="btn-agregar" onclick="addItemToRegistro('${item.nombre}', 'entrega')">Agregar</button>
                            <button class="btn-dar-baja" onclick="addItemToRegistro('${item.nombre}', 'baja')">Dar Baja</button>
                        </div>
                    `;
                    resultsDiv.appendChild(productoDiv);
                });
            } else {
                resultsDiv.innerHTML = '<p>No se encontraron productos.</p>';
            }
        }

        function addItemToRegistro(nombre, tipo) {
            const item = currentInventario.find(i => i.nombre === nombre);
            if (!item) return;

            const registro = tipo === 'entrega' ? registroEntrega : registroBaja;
            const existingItem = registro.find(i => i.nombre === nombre);

            if (existingItem) {
                existingItem.cantidad++;
            } else {
                registro.push({ nombre: item.nombre, precio: item.precio, cantidad: 1 });
            }

            if (tipo === 'entrega') {
                localStorage.setItem('registroEntrega', JSON.stringify(registroEntrega));
            } else {
                localStorage.setItem('registroBaja', JSON.stringify(registroBaja));
            }

            alert(`Producto "${nombre}" agregado al registro de ${tipo}.`);
        }
        
        function removeItemFromRegistro(nombre, tipo) {
            if (tipo === 'entrega') {
                registroEntrega = registroEntrega.filter(item => item.nombre !== nombre);
                localStorage.setItem('registroEntrega', JSON.stringify(registroEntrega));
            } else {
                registroBaja = registroBaja.filter(item => item.nombre !== nombre);
                localStorage.setItem('registroBaja', JSON.stringify(registroBaja));
            }
            renderRegistro(tipo);
        }

        function renderRegistro(tipo) {
            const content = document.getElementById('vendedor-content');
            const registro = tipo === 'entrega' ? registroEntrega : registroBaja;
            let total = 0;
            let itemsHtml = '';

            if (registro.length > 0) {
                registro.forEach(item => {
                    const subtotal = item.precio * item.cantidad;
                    total += subtotal;
                    itemsHtml += `
                        <div class="registro-item">
                            <span>${item.nombre} x${item.cantidad} - $${subtotal.toFixed(2)}</span>
                            <button class="btn-quitar" onclick="removeItemFromRegistro('${item.nombre}', '${tipo}')">Quitar</button>
                        </div>
                    `;
                });
            } else {
                itemsHtml = '<p>No hay artículos en este registro.</p>';
            }

            content.innerHTML = `
                <div class="registros-container">
                    <h3>Registro de ${tipo === 'entrega' ? 'Entrega' : 'Baja'}</h3>
                    <div id="registro-list">${itemsHtml}</div>
                    <div class="total-registro">Total: $${total.toFixed(2)}</div>
                    <button class="complete-btn" onclick="createPDF('${tipo}')">Completar ${tipo === 'entrega' ? 'Entrega' : 'Baja'}</button>
                </div>
            `;
        }

        function createPDF(tipo) {
            const registro = tipo === 'entrega' ? registroEntrega : registroBaja;
            if (registro.length === 0) {
                alert('El registro está vacío.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            doc.setFontSize(20);
            doc.text(`Registro de ${tipo === 'entrega' ? 'Entrega' : 'Baja'}`, 10, 10);
            doc.setFontSize(12);
            doc.text(`Fecha: ${fecha}`, 10, 20);
            doc.text(`Vendedor: ${currentUser}`, 10, 26);


            let y = 36;
            let total = 0;
            registro.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                doc.text(`- ${item.nombre} x${item.cantidad} - Precio: $${item.precio.toFixed(2)} - Subtotal: $${subtotal.toFixed(2)}`, 15, y);
                y += 10;
            });

            y += 10;
            doc.text(`Total: $${total.toFixed(2)}`, 10, y);

            doc.save(`Registro_${tipo}_${currentUser}_${fecha}.pdf`);
            
            if (tipo === 'entrega') {
                registroEntrega = [];
                localStorage.setItem('registroEntrega', JSON.stringify(registroEntrega));
            } else {
                registroBaja = [];
                localStorage.setItem('registroBaja', JSON.stringify(registroBaja));
            }
            alert('PDF creado y registro reiniciado.');
            renderRegistro(tipo);
        }

        // Funciones del Administrador
        function renderAdminPanel() {
            document.getElementById('admin-content').innerHTML = `
                <p>Selecciona una opción para administrar el inventario.</p>
            `;
        }

        function renderEditarInventario() {
            const content = document.getElementById('admin-content');
            content.innerHTML = `
                <h3>Editar Inventario</h3>
                <p>Edita el inventario directamente en el archivo JSON. Esta acción solo es para el modo local.</p>
                `;
        }
        
        async function renderCargarRegistro(tipo) {
            const content = document.getElementById('admin-content');
            content.innerHTML = `
                <h3>Cargar Registro de ${tipo === 'entrega' ? 'Entrega' : 'Baja'}</h3>
                <p>Carga el PDF del registro que te envió el vendedor para actualizar el inventario.</p>
                <label for="file-input" class="custom-file-upload">
                    Seleccionar Archivo PDF
                </label>
                <input type="file" id="file-input" accept="application/pdf">
                <div id="pdf-preview" class="pdf-preview hidden">
                    <h4>Contenido del PDF:</h4>
                    <pre id="pdf-content"></pre>
                    <button class="confirm-btn" onclick="realizarCambiosInventario('${tipo}')">Realizar Revaja de Productos</button>
                </div>
            `;
            
            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    readPDF(file, tipo);
                }
            });
        }

        async function readPDF(file, tipo) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                const pdfData = new Uint8Array(this.result);
                const loadingTask = pdfjsLib.getDocument({data: pdfData});
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                const items = textContent.items.map(item => item.str).join(' ');
                
                const previewDiv = document.getElementById('pdf-preview');
                const contentPre = document.getElementById('pdf-content');
                contentPre.textContent = items;
                previewDiv.classList.remove('hidden');

                const lines = items.split('\n').map(line => line.trim()).filter(line => line.startsWith('- '));
                let parsedItems = [];
                lines.forEach(line => {
                    const parts = line.split(' - ');
                    const namePart = parts[0].replace('- ', '');
                    const [nombre, cantidad] = namePart.split(' x');
                    parsedItems.push({
                        nombre: nombre.trim(),
                        cantidad: parseInt(cantidad),
                    });
                });
                localStorage.setItem('tempPdfData', JSON.stringify(parsedItems));
            };
            fileReader.readAsArrayBuffer(file);
        }

        function realizarCambiosInventario(tipo) {
            const data = JSON.parse(localStorage.getItem('tempPdfData'));
            if (!data || data.length === 0) {
                alert('No se encontraron datos para procesar.');
                return;
            }

            const confirmacion = confirm(`¿Estás seguro de que quieres ${tipo === 'entrega' ? 'reducir' : 'dar de baja'} estos productos del inventario?`);
            if (confirmacion) {
                data.forEach(item => {
                    const inventarioItem = db.inventario.find(inv => inv.nombre === item.nombre);
                    if (inventarioItem) {
                        inventarioItem.cantidad -= item.cantidad;
                        if (inventarioItem.cantidad < 0) {
                            inventarioItem.cantidad = 0;
                        }
                    }
                });
                alert('Inventario actualizado. Ahora debes subir el archivo JSON actualizado a tu repositorio de GitHub.');
                
                console.log(JSON.stringify(db, null, 2));
            }
            localStorage.removeItem('tempPdfData');
            document.getElementById('pdf-preview').classList.add('hidden');
        }

        // Lógica de Autenticación y Navegación
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] === password) {
                const fileName = userFiles[username];
                if (fileName) {
                    loadInventory(fileName).then(() => {
                        const sessionData = {
                            username: username,
                            timestamp: new Date().getTime()
                        };
                        localStorage.setItem('session', JSON.stringify(sessionData));
                        currentUser = username;
                        showPanel(username);
                    });
                } else if (username === 'Admin') {
                    // Cargar una base de datos genérica para el admin si no está mapeada, o simplemente mostrar el panel
                    showPanel(username);
                } else {
                    alert('Usuario no tiene un archivo de inventario asignado.');
                }
            } else {
                alert('Usuario o contraseña incorrectos.');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
        });

        document.getElementById('logout-btn-admin').addEventListener('click', () => {
            logout();
        });

        function logout() {
            localStorage.removeItem('session');
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('vendedor-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Eventos del panel de vendedor
        document.getElementById('btn-registro-entrega').addEventListener('click', () => renderRegistro('entrega'));
        document.getElementById('btn-registro-baja').addEventListener('click', () => renderRegistro('baja'));
        document.getElementById('btn-inventario-total').addEventListener('click', () => renderInventario());

        // Eventos del panel de administrador
        document.getElementById('btn-editar-inventario').addEventListener('click', () => renderEditarInventario());
        document.getElementById('btn-cargar-entrega').addEventListener('click', () => renderCargarRegistro('entrega'));
        document.getElementById('btn-cargar-baja').addEventListener('click', () => renderCargarRegistro('baja'));

        // Cargar el inventario y verificar la sesión al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });
    </script>
</body>
</html>
